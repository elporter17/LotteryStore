<!-- PANEL DE ADMINISTRACI√ìN CON ACORDE√ìN -->
<div class="admin-interface">
  
  <!-- Header -->
  <div class="header-bar">
    <div class="admin-title">
      <h2><i class="fas fa-cog"></i> Panel de Administraci√≥n</h2>
    </div>
    
    <div class="header-actions">
      <button class="btn-header btn-cierre-caja" (click)="abrirModalCierreCaja()"
              [disabled]="showCierreCajaModal">
        <i class="fas fa-cash-register"></i> üí∞ Cierre de Caja
        <span *ngIf="showCierreCajaModal" style="margin-left: 10px; color: green;">‚úÖ</span>
      </button>
      
      <button class="btn-header btn-users" (click)="navigateToUsers()" [disabled]="isLoading">
        <i class="fas fa-users"></i> Gesti√≥n de Usuarios
      </button>
      
      <button class="btn-header btn-cerrar" (click)="logout()" [disabled]="isLoading">
        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
      </button>
    </div>
  </div>

  <!-- Filtros de Fecha -->
  <div class="filters-bar">
    <div class="filter-group">
      <label for="fechaDesde">
        <i class="fas fa-calendar-alt"></i>
        Desde:
        <span class="loading-indicator" *ngIf="isLoadingFilters">
          <i class="fas fa-spinner fa-spin"></i>
        </span>
      </label>
      <input type="datetime-local" id="fechaDesde" class="form-control" 
             [(ngModel)]="fechaDesde" (change)="onFiltroFechaChange()"
             [disabled]="isLoadingFilters">
    </div>
    
    <div class="filter-group">
      <label for="fechaHasta">
        <i class="fas fa-calendar-alt"></i>
        Hasta:
        <span class="loading-indicator" *ngIf="isLoadingFilters">
          <i class="fas fa-spinner fa-spin"></i>
        </span>
      </label>
      <input type="datetime-local" id="fechaHasta" class="form-control" 
             [(ngModel)]="fechaHasta" (change)="onFiltroFechaChange()"
             [disabled]="isLoadingFilters">
    </div>
    
    <div class="filter-group">
      <label for="sorteoFilter">
        <i class="fas fa-trophy"></i>
        Sorteo:
        <span class="loading-indicator" *ngIf="isLoadingFilters">
          <i class="fas fa-spinner fa-spin"></i>
        </span>
      </label>
      <select id="sorteoFilter" class="form-control" 
              [(ngModel)]="selectedSorteoFilter" (change)="aplicarFiltros()"
              [disabled]="isLoadingFilters">
        <option value="">Todos los sorteos</option>
        <option *ngFor="let sorteo of sorteos" [value]="sorteo.name">{{ sorteo.label }}</option>
      </select>
    </div>
    
    <div class="filter-actions">
      <button class="btn-filter btn-primary" (click)="aplicarFiltros()" [disabled]="isLoading || isLoadingFilters">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoadingFilters; else searchIcon"></i>
        <ng-template #searchIcon><i class="fas fa-search"></i></ng-template>
        {{ isLoadingFilters ? 'Filtrando...' : 'Filtrar' }}
      </button>
      <button class="btn-filter btn-secondary" (click)="limpiarFiltros()" [disabled]="isLoading || isLoadingFilters">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoadingFilters; else eraserIcon"></i>
        <ng-template #eraserIcon><i class="fas fa-eraser"></i></ng-template>
        {{ isLoadingFilters ? 'Limpiando...' : 'Limpiar' }}
      </button>
    </div>

    <!-- Botones de Exportaci√≥n -->
    <div class="export-actions">
      <div class="export-label">
        <i class="fas fa-download"></i>
        Descargar Reporte Diario:
      </div>
      <button class="btn-export btn-excel" (click)="downloadDailyReportExcel()" [disabled]="isLoading">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoading; else excelIcon"></i>
        <ng-template #excelIcon><i class="fas fa-file-excel"></i></ng-template>
        Excel
      </button>
      <button class="btn-export btn-pdf" (click)="downloadDailyReportPDF()" [disabled]="isLoading">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoading; else pdfIcon"></i>
        <ng-template #pdfIcon><i class="fas fa-file-pdf"></i></ng-template>
        PDF
      </button>
    </div>
  </div>

  <!-- Contenido Principal -->
  <div class="main-content">
    
    <!-- Cards de Resumen -->
    <div class="summary-cards">
      <div class="summary-card vendido">
        <div class="card-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="card-content">
          <h3>L {{ getTotalVendido().toFixed(2) }}</h3>
          <p>Total Vendido</p>
        </div>
      </div>
      
      <div class="summary-card pagado">
        <div class="card-icon">
          <i class="fas fa-coins"></i>
        </div>
        <div class="card-content">
          <h3>L {{ getTotalPagado().toFixed(2) }}</h3>
          <p>Total Pagado</p>
        </div>
      </div>
      
      <div class="summary-card ganancia" [class.positive]="getGananciaNeta() > 0" [class.negative]="getGananciaNeta() < 0">
        <div class="card-icon">
          <i class="fas fa-piggy-bank"></i>
        </div>
        <div class="card-content">
          <h3>L {{ getGananciaNeta().toFixed(2) }}</h3>
          <p>Ganancia Neta</p>
        </div>
      </div>
      
      <div class="summary-card ventas">
        <div class="card-icon">
          <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="card-content">
          <h3>{{ getTotalVentas() }}</h3>
          <p>Ventas Totales</p>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Informaci√≥n del N√∫mero Ganador -->
    <div class="numero-ganador-section" *ngIf="resumenSucursales && resumenSucursales.length > 0">
      <div class="section-header">
        <h3><i class="fas fa-trophy"></i> Informaci√≥n del N√∫mero Ganador</h3>
        <div class="section-subtitle">Detalle de pagos por sucursal</div>
      </div>
      
      <div class="numero-ganador-card">
        <div class="numero-ganador-header">
          <div class="numero-display">
            <span class="numero-text">{{ resumenSucursales[0]?.numero_ganador || '00' }}</span>
            <span class="numero-label">N√∫mero Ganador</span>
          </div>
          <div class="totales-general">
            <div class="total-item">
              <span class="total-value">L {{ getTotalCantidadNumeroGanador().toFixed(2) }}</span>
              <span class="total-label">Total Comprado</span>
            </div>
            <div class="total-item">
              <span class="total-value">L {{ getTotalPagadoGeneral() }}</span>
              <span class="total-label">Total a Pagar</span>
            </div>
          </div>
        </div>
        
        <div class="sucursales-detalle">
          <div class="detalle-header">
            <span>Sucursal</span>
            <span>Factor</span>
            <span>Cantidad</span>
            <span>Pago</span>
          </div>
          <div class="detalle-row" *ngFor="let sucursal of resumenSucursales">
            <span class="sucursal-name">{{ sucursal.sucursal }}</span>
            <span class="factor-value">{{ sucursal.factor_multiplicador }}x</span>
            <span class="cantidad-value">L {{ (sucursal.cantidad_numero_ganador || 0).toFixed(2) }}</span>
            <span class="pago-value">L {{ ((sucursal.cantidad_numero_ganador || 0) * (sucursal.factor_multiplicador || 1)).toFixed(2) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de N√∫meros Vendidos por Sorteo -->
    <div class="numeros-vendidos-section">
      <div class="section-header">
        <h3><i class="fas fa-chart-bar"></i> N√∫meros Vendidos por Sorteo</h3>
        <div class="section-subtitle">Vista en tiempo real de las ventas por sorteo</div>
      </div>
      
      <div class="sorteos-numeros-grid" *ngIf="sales.length > 0; else noVentasNumeros">
        <div *ngFor="let sorteoGroup of getNumbersSummaryBySorteoAndSucursal()" class="sorteo-numeros-card">
          <div class="sorteo-numeros-header">
            <h4>{{ sorteoGroup.sorteo }}</h4>
            <div class="sorteo-total">
              Total: L {{ getSorteoTotal(sorteoGroup).toFixed(2) }}
            </div>
          </div>
          
          <div class="sucursales-container">
            <div *ngFor="let sucursalGroup of sorteoGroup.sucursales" class="sucursal-group">
              <div class="sucursal-header">
                <h5>{{ sucursalGroup.sucursal }}</h5>
                <span class="sucursal-total">L {{ getSucursalTotal(sucursalGroup).toFixed(2) }}</span>
              </div>
              
              <!-- Top 5 n√∫meros m√°s vendidos -->
              <div class="top-numeros-section">
                <h6>
                  <i class="fas fa-trophy"></i>
                  Top 5 N√∫meros M√°s Vendidos
                </h6>
                <div class="top-numeros-grid">
                  <div class="top-numero-card" *ngFor="let numero of sucursalGroup.numeros.slice(0, 5); let i = index">
                    <div class="numero">{{ numero.numero.toString().padStart(2, '0') }}</div>
                    <div class="cantidad">L {{ numero.totalVendido.toFixed(2) }}</div>
                    <div class="posicion">#{{ i + 1 }}</div>
                  </div>
                </div>
              </div>

              <!-- Tablero completo de n√∫meros 00-99 -->
              <div class="tablero-numeros">
                <h6>
                  <i class="fas fa-grid-3x3"></i>
                  Tablero Completo (00-99)
                </h6>
                <div class="numeros-grid-completo">
                  <div class="numero-cell" 
                       *ngFor="let num of getAllNumbers()"
                       [class]="getNumeroIntensity(sucursalGroup, num)"
                       [title]="'N√∫mero ' + num.toString().padStart(2, '0') + ': L ' + getNumeroVenta(sucursalGroup, num).toFixed(2)">
                    <span class="numero-label">{{ num.toString().padStart(2, '0') }}</span>
                    <span class="numero-venta">L {{ getNumeroVenta(sucursalGroup, num).toFixed(2) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <ng-template #noVentasNumeros>
        <div class="no-data-message">
          <i class="fas fa-chart-bar"></i>
          <h4>No hay ventas por n√∫meros para mostrar</h4>
          <p>Las estad√≠sticas aparecer√°n cuando haya ventas registradas</p>
        </div>
      </ng-template>
    </div>

    <!-- Secci√≥n de Sorteos con estilo minimalista -->
    <div class="sorteos-section">
      <div class="section-header">
        <h3><i class="fas fa-dice"></i> Gesti√≥n de Sorteos</h3>
      </div>
      
      <div class="sorteos-grid">
        <div *ngFor="let sorteo of sorteos" class="sorteo-card">
          <div class="sorteo-header">
            <h4>{{ sorteo.label }}</h4>
            <div class="sorteo-status">
              <span class="status-badge" [class.open]="isSorteoOpen(sorteo)" [class.closed]="!isSorteoOpen(sorteo)">
                {{ isSorteoOpen(sorteo) ? 'Abierto' : 'Cerrado' }}
              </span>
              <span class="close-time">{{ sorteo.closeTime }}</span>
            </div>
          </div>
          
          <div class="sorteo-content">
            <!-- Mostrar resultados solo si hay datos GUARDADOS en BD -->
            <div *ngIf="hasSavedWinner(sorteo); else setWinner">
              <!-- Resultados del sorteo -->
              <div class="winner-section">
                <div class="winner-number">
                  <i class="fas fa-trophy"></i>
                  <span>{{ getSorteoData(sorteo)?.numeroGanador || 'N/A' }}</span>
                </div>
                <div class="factor">Factor: {{ getSorteoData(sorteo)?.factorMultiplicador || 70 }}</div>
              </div>
            
            </div>
            
            <ng-template #setWinner>
              <!-- Formulario para establecer ganador solo si no est√° abierto -->
              <div *ngIf="!isSorteoOpen(sorteo)" class="winner-form">
                <div class="form-group">
                  <label>N√∫mero Ganador:</label>
                  <input type="number" class="form-input" min="1" max="99" 
                         [(ngModel)]="winningNumbers[sorteo.name]" 
                         [disabled]="isLoading"
                         placeholder="Ingrese n√∫mero (1-99)">
                </div>
                <button class="btn-set-winner" (click)="openFactorsModal(sorteo.name, +winningNumbers[sorteo.name])" 
                        [disabled]="!winningNumbers[sorteo.name] || isLoading">
                  <i class="fas fa-cog"></i> 
                  <span *ngIf="isLoading">Cargando...</span>
                  <span *ngIf="!isLoading">Configurar Factores</span>
                </button>
              </div>
              
              <!-- Mensaje cuando el sorteo est√° abierto -->
              <div *ngIf="isSorteoOpen(sorteo)" class="sorteo-open-message">
                <i class="fas fa-clock"></i>
                <span>Sorteo abierto - Esperando cierre</span>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- Componente de Resumen de Sorteos -->
    <app-resumen-sorteos></app-resumen-sorteos>

  </div>
</div>

<!-- Modal para crear/editar usuario -->
<div class="modal fade" [class.show]="showUserModal" [style.display]="showUserModal ? 'block' : 'none'" 
     tabindex="-1" role="dialog" (click)="showUserModal && $event.target === $event.currentTarget && closeUserModal()">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user"></i> {{ editingUser ? 'Editar Usuario' : 'Crear Usuario' }}
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeUserModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form #userForm="ngForm">
          <div class="form-group">
            <label for="userEmail">Email:</label>
            <input type="email" id="userEmail" class="form-input" required
                   [(ngModel)]="userFormData.email" name="email" 
                   placeholder="usuario@ejemplo.com">
          </div>

          <div class="form-group">
            <label for="userName">Nombre:</label>
            <input type="text" id="userName" class="form-input"
                   [(ngModel)]="userFormData.nombre" name="nombre" 
                   placeholder="Nombre completo del usuario">
          </div>
          
          <div class="form-group" *ngIf="!editingUser">
            <label for="userPassword">Contrase√±a:</label>
            <input type="password" id="userPassword" class="form-input" required
                   [(ngModel)]="userFormData.password" name="password" 
                   placeholder="Contrase√±a segura">
          </div>
          
          <div class="form-group">
            <label for="userRole">Rol:</label>
            <select id="userRole" class="form-input" 
                    [(ngModel)]="userFormData.role" name="role" required>
              <option value="admin">Administrador</option>
              <option value="sucursal">Sucursal</option>
            </select>
          </div>
          
          <div class="form-group" *ngIf="userFormData.role === 'sucursal'">
            <label for="userSucursal">Sucursal:</label>
            <input type="text" id="userSucursal" class="form-input" 
                   [(ngModel)]="userFormData.sucursal" name="sucursal" 
                   placeholder="Nombre de la sucursal">
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="userFormData.active" name="active">
              <span class="checkmark"></span>
              Usuario Activo
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-secondary" (click)="closeUserModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn-modal btn-primary" (click)="saveUser()" 
                [disabled]="!userForm.valid || isLoading">
          <i class="fas fa-save"></i> {{ editingUser ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>
</div>
 

<!-- Modal para cambiar contrase√±a de usuario -->
<div class="modal fade" [class.show]="showPasswordModal" [style.display]="showPasswordModal ? 'block' : 'none'" 
     tabindex="-1" role="dialog" (click)="showPasswordModal && $event.target === $event.currentTarget && closePasswordModal()">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-key"></i> Cambiar Contrase√±a
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closePasswordModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form #passwordForm="ngForm">
          <div class="form-group">
            <label for="newPassword">Nueva Contrase√±a:</label>
            <input type="password" id="newPassword" class="form-input" required
                   [(ngModel)]="newPassword" name="newPassword" 
                   placeholder="Ingrese la nueva contrase√±a">
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirmar Contrase√±a:</label>
            <input type="password" id="confirmPassword" class="form-input" required
                   [(ngModel)]="confirmPassword" name="confirmPassword" 
                   placeholder="Confirme la nueva contrase√±a">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-secondary" (click)="closePasswordModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn-modal btn-primary" (click)="changeUserPassword()" 
                [disabled]="!passwordForm.valid || newPassword !== confirmPassword || isLoading">
          <i class="fas fa-save"></i> Cambiar Contrase√±a
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE DETALLES DE VENTA -->
<div class="modal" [style.display]="showSaleDetailModal ? 'flex' : 'none'" 
     [class.show]="showSaleDetailModal" 
     (keydown.escape)="closeSaleDetailModal()"
     tabindex="0">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-receipt"></i> Detalles de Venta</h3>
        <button type="button" class="btn-close" (click)="closeSaleDetailModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body" *ngIf="selectedSaleForDetail">
        <!-- Informaci√≥n General -->
        <div class="sale-info-grid">
          <div class="info-row">
            <span class="label">Recibo:</span>
            <span class="value">{{ selectedSaleForDetail.numeroRecibo }}</span>
          </div>
          <div class="info-row">
            <span class="label">Correlativo:</span>
            <span class="value">{{ selectedSaleForDetail.correlativo }}</span>
          </div>
          <div class="info-row">
            <span class="label">Fecha:</span>
            <span class="value">{{ formatDateTime(selectedSaleForDetail.createdAt) }}</span>
          </div>
          <div class="info-row">
            <span class="label">Sucursal:</span>
            <span class="value">{{ selectedSaleForDetail.sucursal }}</span>
          </div>
          <div class="info-row">
            <span class="label">Sorteo:</span>
            <span class="value text-capitalize">{{ selectedSaleForDetail.sorteo }}</span>
          </div>
          <div class="info-row total-row">
            <span class="label">Total:</span>
            <span class="value">L {{ selectedSaleForDetail.total.toFixed(2) }}</span>
          </div>
        </div>

        <!-- N√∫meros Jugados -->
        <div class="numbers-section" *ngIf="selectedSaleDetails.length > 0">
          <h4><i class="fas fa-list"></i> N√∫meros Jugados</h4>
          <div class="numbers-grid">
            <div class="number-item" *ngFor="let detail of selectedSaleDetails; trackBy: trackBySaleDetail">
              <div class="number-card">
                <div class="number">{{ detail.numero.toString().padStart(2, '0') }}</div>
                <div class="amount">L {{ detail.monto.toFixed(2) }}</div>
              </div>
            </div>
          </div>
          
          <div class="numbers-summary">
            <div class="summary-item">
              <span class="label">Cantidad de n√∫meros:</span>
              <span class="value">{{ selectedSaleDetails.length }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Total apostado:</span>
              <span class="value">L {{ getTotalNumeros().toFixed(2) }}</span>
            </div>
          </div>
        </div>
        
        <div class="no-numbers" *ngIf="selectedSaleDetails.length === 0">
          <i class="fas fa-exclamation-triangle"></i>
          <p>No se encontraron n√∫meros para esta venta</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-primary" (click)="reprintReceipt(selectedSaleForDetail!)" 
                [disabled]="isLoading">
          <i class="fas fa-print"></i> Reimprimir Recibo
        </button>
        <button type="button" class="btn-modal btn-secondary" (click)="closeSaleDetailModal()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para configurar factores por sucursal -->
<div class="modal-overlay" *ngIf="showFactorsModal" (click)="closeFactorsModal()">
  <div class="modal-container factors-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-calculator"></i>
        Configurar Factores por Sucursal
      </h3>
      <div class="sorteo-info" *ngIf="currentSorteoForFactors">
        <div class="sorteo-badge">{{ currentSorteoForFactors.sorteo.label }}</div>
        <div class="winning-number">N√∫mero Ganador: {{ currentSorteoForFactors.winningNumber.padStart(2, '0') }}</div>
      </div>
      <button class="btn-close" (click)="closeFactorsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="factors-instruction">
        <i class="fas fa-info-circle"></i>
        <p>Configure el factor multiplicador para cada sucursal. Este factor determinar√° cu√°nto se paga por cada n√∫mero ganador.</p>
      </div>

      <div class="factors-list" *ngIf="sucursalesFactores.length > 0">
        <div class="factor-item" *ngFor="let sucursal of getUniqueSucursales(); let i = index">
          <div class="sucursal-info">
            <div class="sucursal-name">
              <i class="fas fa-store"></i>
              {{ sucursal }}
            </div>
            <div class="sucursal-users" *ngIf="hasSucursalUsers(sucursal)">
              <small>
                Usuarios: 
                <span *ngFor="let user of getUsersBySucursal(sucursal); let last = last">
                  {{ user.email }}{{ !last ? ', ' : '' }}
                </span>
              </small>
            </div>
          </div>
          
          <div class="factor-input">
            <label>Factor (ej: 70)</label>
            <div class="input-with-x">
              <input 
                type="number" 
                min="1" 
                max="999" 
                step="0.1"
                [value]="factoresPorSucursal[sucursal] || 75" 
                (input)="updateFactorForSucursal(sucursal, $any($event.target).value)"
                placeholder="70">
              <span class="x-multiplier">x</span>
            </div>
          </div>
        </div>
      </div>

      <div class="loading-factors" *ngIf="isLoading && sucursalesFactores.length === 0">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando configuraci√≥n de sucursales...</p>
      </div>

      <div class="no-sucursales" *ngIf="!isLoading && sucursalesFactores.length === 0">
        <i class="fas fa-exclamation-triangle"></i>
        <p>No se encontraron sucursales activas</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-modal btn-secondary" (click)="closeFactorsModal()" [disabled]="isLoading">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button class="btn-modal btn-primary" (click)="confirmWinningNumberWithFactors()" [disabled]="isLoading">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
        <i class="fas fa-trophy" *ngIf="!isLoading"></i>
        {{ isLoading ? 'Estableciendo...' : 'Establecer Ganador' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal para mostrar resumen por sucursales -->
<div class="modal-overlay" *ngIf="showResumenModal" (click)="closeResumenModal()">
  <div class="modal-container resumen-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-chart-bar"></i>
        Resumen de Cierre por Sucursales
      </h3>
      <button type="button" class="btn-close" (click)="closeResumenModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="sorteo-info">
        <h4>{{ currentSorteoForResumen }}</h4>
      </div>
      
      <div class="resumen-table">
        <div class="table-header">
          <div class="col-sucursal">Sucursal</div>
          <div class="col-factor">Factor</div>
          <div class="col-numero-ganador">Cantidad #{{ resumenSucursales[0]?.numero_ganador || '00' }}</div>
          <div class="col-vendido">Total Vendido</div>
          <div class="col-pagado">Total Pagado</div>
          <div class="col-ganancia">Ganancia Neta</div>
        </div>
        
        <div class="table-row" *ngFor="let sucursal of resumenSucursales">
          <div class="col-sucursal">{{ sucursal.sucursal }}</div>
          <div class="col-factor">{{ sucursal.factor_multiplicador }}x</div>
          <div class="col-numero-ganador">
            <span class="cantidad-numero">L {{ (sucursal.cantidad_numero_ganador || 0).toFixed(2) }}</span>
            <small class="multiplicacion">x{{ sucursal.factor_multiplicador }} = L {{ ((sucursal.cantidad_numero_ganador || 0) * (sucursal.factor_multiplicador || 1)).toFixed(2) }}</small>
          </div>
          <div class="col-vendido">L {{ sucursal.total_vendido?.toFixed(2) || '0.00' }}</div>
          <div class="col-pagado">L {{ sucursal.total_pagado?.toFixed(2) || '0.00' }}</div>
          <div class="col-ganancia" 
               [class.positive]="(sucursal.ganancia_neta || 0) > 0"
               [class.negative]="(sucursal.ganancia_neta || 0) < 0">
            L {{ sucursal.ganancia_neta?.toFixed(2) || '0.00' }}
          </div>
        </div>
        
        <!-- Totales generales -->
        <div class="table-footer">
          <div class="col-sucursal"><strong>TOTAL GENERAL</strong></div>
          <div class="col-factor">-</div>
          <div class="col-numero-ganador">
            <strong>L {{ getTotalCantidadNumeroGanador().toFixed(2) }}</strong>
          </div>
          <div class="col-vendido">
            <strong>L {{ getTotalVendidoGeneral() }}</strong>
          </div>
          <div class="col-pagado">
            <strong>L {{ getTotalPagadoGeneral() }}</strong>
          </div>
          <div class="col-ganancia"
               [class.positive]="getGananciaTotalGeneral() > 0"
               [class.negative]="getGananciaTotalGeneral() < 0">
            <strong>L {{ getGananciaTotalGeneral().toFixed(2) }}</strong>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-modal btn-primary" (click)="closeResumenModal()">
        <i class="fas fa-check"></i>
        Entendido
      </button>
    </div>
  </div>
</div>

<!-- Bottom Sheet de Cierre de Caja por Sucursal -->
<div class="bottom-sheet-overlay" 
     [class.show]="showCierreCajaModal" 
     [hidden]="!showCierreCajaModal"
     (click)="showCierreCajaModal && $event.target === $event.currentTarget && cerrarModalCierreCaja()">
  
  <div class="bottom-sheet-container" [class.show]="showCierreCajaModal">
    <!-- Handle para arrastrar -->
    <div class="bottom-sheet-handle">
      <div class="handle-bar"></div>
    </div>
    
    <!-- Header del Bottom Sheet -->
    <div class="bottom-sheet-header">
      <div class="header-content">
        <h4 class="sheet-title">
          <i class="fas fa-cash-register"></i>
          üí∞ Cierre de Caja
        </h4>
        <button type="button" class="btn-close-sheet" (click)="cerrarModalCierreCaja()" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    
    <!-- Contenido del Bottom Sheet -->
    <div class="bottom-sheet-body">
      <!-- Selecci√≥n de Sucursal y Fecha -->
      <div class="selection-container">
        <div class="selection-grid">
          <div class="selection-item">
            <label for="sucursalSelector" class="selection-label">
              <i class="fas fa-store"></i> Sucursal
            </label>
            <select id="sucursalSelector" 
                    class="selection-input" 
                    [(ngModel)]="selectedSucursalForCierre"
                    (change)="onSucursalSeleccionada()"
                    [disabled]="loadingCierreCaja">
              <option value="">-- Seleccione --</option>
              <option *ngFor="let sucursal of sucursalesDisponibles" [value]="sucursal">
                {{ sucursal }}
              </option>
            </select>
          </div>
          
          <div class="selection-item">
            <label for="fechaSelector" class="selection-label">
              <i class="fas fa-calendar"></i> Fecha
            </label>
            <input type="date" 
                   id="fechaSelector"
                   class="selection-input" 
                   [(ngModel)]="fechaCierreSeleccionada"
                   (change)="onFechaCierreChange()"
                   [disabled]="loadingCierreCaja">
          </div>
        </div>
      </div>

      <!-- Estado de Carga -->
      <div *ngIf="loadingCierreCaja" class="loading-section">
        <div class="loading-content">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Cargando datos...</span>
        </div>
      </div>

      <!-- Contenido Principal del Cierre de Caja -->
      <div *ngIf="!loadingCierreCaja && selectedSucursalForCierre && resumenCajaSucursal" class="cierre-content">
        
        <!-- Info Header -->
        <div class="info-header">
          <div class="date-info">
            <i class="fas fa-calendar"></i>
            {{ fechaCierreSeleccionada | date:'dd/MM/yyyy' }}
          </div>
          <div class="sucursal-info">
            <i class="fas fa-store"></i>
            {{ selectedSucursalForCierre }}
          </div>
        </div>

        <!-- Estado del Cierre -->
        <div class="cierre-status-indicator" 
             [ngClass]="cierreExistenteSucursal ? 'status-closed' : 'status-open'">
          <div class="status-content">
            <i class="fas" [ngClass]="cierreExistenteSucursal ? 'fa-lock' : 'fa-clock'"></i>
            <span>{{ cierreExistenteSucursal ? 'Cierre ya realizado' : 'Cierre pendiente' }}</span>
            <span *ngIf="cierreExistenteSucursal" class="status-date">
              ({{ formatFechaCierre(cierreExistenteSucursal) }})
            </span>
          </div>
        </div>

        <!-- Resumen Financiero Cards -->
        <div class="financial-summary">
          <div class="summary-title">
            <i class="fas fa-chart-line"></i>
            Resumen del D√≠a
          </div>
          
          <div class="summary-cards">
            <div class="summary-card vendido">
              <div class="card-icon">üíµ</div>
              <div class="card-content">
                <div class="card-label">Total Vendido</div>
                <div class="card-amount positive">{{ formatearMontoSucursal(resumenCajaSucursal.total_vendido || 0) }}</div>
              </div>
            </div>
            
            <div class="summary-card pagado">
              <div class="card-icon">üí∞</div>
              <div class="card-content">
                <div class="card-label">Total Pagado</div>
                <div class="card-amount negative">{{ formatearMontoSucursal(resumenCajaSucursal.total_pagado || 0) }}</div>
              </div>
            </div>
            
            <div class="summary-card ganancia">
              <div class="card-icon">üìà</div>
              <div class="card-content">
                <div class="card-label">Ganancia Neta</div>
                <div class="card-amount" [class.positive]="(resumenCajaSucursal.total_neto || 0) > 0" [class.negative]="(resumenCajaSucursal.total_neto || 0) < 0">
                  {{ formatearMontoSucursal(resumenCajaSucursal.total_neto || 0) }}
                </div>
              </div>
            </div>
            
            <div class="summary-card balance">
              <div class="card-icon">üè¶</div>
              <div class="card-content">
                <div class="card-label">Balance Final</div>
                <div class="card-amount balance">{{ formatearMontoSucursal(resumenCajaSucursal.balance_final || 0) }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sorteos del D√≠a -->
        <div class="section" *ngIf="sorteosPendientesPagoSucursal.length > 0">
          <div class="section-header">
            <h5>
              <i class="fas fa-dice"></i>
              Sorteos del D√≠a
              <span class="badge">{{ sorteosPendientesPagoSucursal.length }}</span>
            </h5>
          </div>
          <div class="pending-list">
            <div *ngFor="let sorteo of sorteosPendientesPagoSucursal" class="pending-item-detailed">
              <div class="sorteo-header">
                <div class="sorteo-name">{{ sorteo.sorteo.toUpperCase() }}</div>
                <div class="sorteo-status" 
                     [ngClass]="{
                       'status-paid': sorteo.ya_pagado,
                       'status-pending': !sorteo.ya_pagado
                     }">
                  <i class="fas" [ngClass]="{
                    'fa-check-circle': sorteo.ya_pagado,
                    'fa-exclamation-circle': !sorteo.ya_pagado
                  }"></i>
                  {{ sorteo.ya_pagado ? 'Ya Pagado' : 'Pendiente de Pago' }}
                </div>
              </div>
              
              <div class="sorteo-calculation">
                <div class="calculation-row">
                  <div class="calc-item">
                    <div class="calc-label">
                      <i class="fas fa-trophy"></i>
                      N√∫mero Ganador
                    </div>
                    <div class="calc-value winning-number">
                      #{{ sorteo.numero_ganador }}
                    </div>
                  </div>
                  
                  <div class="calc-item">
                    <div class="calc-label">
                      <i class="fas fa-shopping-cart"></i>
                      Cantidad Comprada
                    </div>
                    <div class="calc-value">
                      L {{ sorteo.cantidad_comprada_numero_ganador?.toFixed(2) || '0.00' }}
                    </div>
                  </div>
                  
                  <div class="calc-item">
                    <div class="calc-label">
                      <i class="fas fa-times"></i>
                      Factor
                    </div>
                    <div class="calc-value factor">
                      {{ sorteo.factor_multiplicador }}x
                    </div>
                  </div>
                </div>
                
                <div class="calculation-formula">
                  <div class="formula-display">
                    <span class="formula-part">L {{ sorteo.cantidad_comprada_numero_ganador?.toFixed(2) || '0.00' }}</span>
                    <span class="formula-operator">√ó</span>
                    <span class="formula-part">{{ sorteo.factor_multiplicador }}</span>
                    <span class="formula-operator">=</span>
                    <span class="formula-result">L {{ sorteo.total_calculado_pagar?.toFixed(2) || '0.00' }}</span>
                  </div>
                  <div class="formula-label">Total a Pagar</div>
                </div>
                
                <!-- Verificaci√≥n de c√°lculo -->
                <div class="calculation-verification">
                  <div class="verification-success" 
                       *ngIf="sorteo.calculo_detalle?.coincide">
                    <i class="fas fa-check-circle"></i>
                    <span>‚úÖ C√°lculo correcto: L {{ sorteo.total_calculado_pagar?.toFixed(2) || '0.00' }}</span>
                  </div>
                  
                  <div class="verification-warning" 
                       *ngIf="!sorteo.calculo_detalle?.coincide">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="warning-content">
                      <div class="warning-title">‚ö†Ô∏è Diferencia encontrada</div>
                      <div class="warning-details">
                        <span>Calculado: L {{ sorteo.total_calculado_pagar?.toFixed(2) || '0.00' }}</span>
                        <span>Original: L {{ sorteo.total_pagado?.toFixed(2) || '0.00' }}</span>
                        <span class="difference">Diferencia: L {{ sorteo.calculo_detalle?.diferencia?.toFixed(2) || '0.00' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Movimientos del D√≠a -->
        <div class="section" *ngIf="movimientosCajaSucursal.length > 0">
          <div class="section-header">
            <h5>
              <i class="fas fa-exchange-alt"></i>
              Movimientos del D√≠a
              <span class="badge">{{ movimientosCajaSucursal.length }}</span>
            </h5>
          </div>
          <div class="movements-list">
            <div *ngFor="let movimiento of movimientosCajaSucursal" class="movement-item">
              <div class="movement-time">
                {{ movimiento.fecha | date:'HH:mm' }}
              </div>
              <div class="movement-info">
                <div class="movement-type" [ngClass]="getTipoMovimientoClassSucursal(movimiento.tipo)">
                  {{ getTipoMovimientoTextoSucursal(movimiento.tipo) }}
                </div>
                <div class="movement-reason">{{ movimiento.motivo }}</div>
              </div>
              <div class="movement-amount" [ngClass]="getTipoMovimientoClassSucursal(movimiento.tipo)">
                {{ movimiento.tipo === 'entrada' ? '+' : '-' }}{{ formatearMontoSucursal(movimiento.monto) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Mensajes informativos -->
        <div *ngIf="movimientosCajaSucursal.length === 0" class="info-message">
          <i class="fas fa-info-circle"></i>
          No hay movimientos registrados para hoy.
        </div>

        <div *ngIf="sorteosPendientesPagoSucursal.length === 0" class="info-message">
          <i class="fas fa-info-circle"></i>
          No hay sorteos con premios para mostrar.
        </div>

      </div>

      <!-- Mensaje de selecci√≥n -->
      <div *ngIf="!selectedSucursalForCierre && !loadingCierreCaja" class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-store"></i>
        </div>
        <h5>Seleccione una sucursal</h5>
        <p>Elija una sucursal para ver su cierre de caja</p>
      </div>

    </div>
    
    <!-- Footer del Bottom Sheet -->
    <div class="bottom-sheet-footer" *ngIf="resumenCajaSucursal">
      <button class="btn-sheet btn-secondary" (click)="cerrarModalCierreCaja()">
        <i class="fas fa-times"></i>
        Cerrar
      </button>
      <button class="btn-sheet btn-primary" (click)="imprimirResumenCajaSucursal()">
        <i class="fas fa-print"></i>
        {{ cierreExistenteSucursal ? 'Reimprimir Resumen' : 'Imprimir Resumen' }}
      </button>
      <button 
        class="btn-sheet btn-info" 
        (click)="imprimirCierreDiarioSucursal()"
        [disabled]="!cierreExistenteSucursal"
        *ngIf="cierreExistenteSucursal">
        <i class="fas fa-file-alt"></i>
        Reimprimir Cierre
      </button>
    </div>
  </div>
</div>
