<!-- PANEL DE ADMINISTRACIÓN CON ACORDEÓN -->
<div class="admin-interface">
  <!-- Header -->
  <div class="header-bar">
    <div class="admin-title">
      <h2><i class="fas fa-cog"></i> Panel de Administración</h2>
    </div>
    
    <button class="btn-header btn-cerrar" (click)="logout()" [disabled]="isLoading">
      <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
    </button>
  </div>

  <!-- Filtros de Fecha -->
  <div class="filters-bar">
    <div class="filter-group">
      <label for="fechaDesde">Desde:</label>
      <input type="datetime-local" id="fechaDesde" class="form-control" 
             [(ngModel)]="fechaDesde" (change)="onFiltroFechaChange()">
    </div>
    
    <div class="filter-group">
      <label for="fechaHasta">Hasta:</label>
      <input type="datetime-local" id="fechaHasta" class="form-control" 
             [(ngModel)]="fechaHasta" (change)="onFiltroFechaChange()">
    </div>
    
    <div class="filter-group">
      <label for="sorteoFilter">Sorteo:</label>
      <select id="sorteoFilter" class="form-control" 
              [(ngModel)]="selectedSorteoFilter" (change)="aplicarFiltros()">
        <option value="">Todos los sorteos</option>
        <option *ngFor="let sorteo of sorteos" [value]="sorteo.name">{{ sorteo.label }}</option>
      </select>
    </div>
    
    <div class="filter-actions">
      <button class="btn-filter btn-primary" (click)="aplicarFiltros()" [disabled]="isLoading || isLoadingFilters">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoadingFilters; else searchIcon"></i>
        <ng-template #searchIcon><i class="fas fa-search"></i></ng-template>
        {{ isLoadingFilters ? 'Filtrando...' : 'Filtrar' }}
      </button>
      <button class="btn-filter btn-secondary" (click)="limpiarFiltros()" [disabled]="isLoading || isLoadingFilters">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoadingFilters; else eraserIcon"></i>
        <ng-template #eraserIcon><i class="fas fa-eraser"></i></ng-template>
        {{ isLoadingFilters ? 'Limpiando...' : 'Limpiar' }}
      </button>
    </div>
  </div>

  <!-- Contenido Principal -->
  <div class="main-content">
    
    <!-- Cards de Resumen -->
    <div class="summary-cards">
      <div class="summary-card vendido">
        <div class="card-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="card-content">
          <h3>L {{ getTotalVendido().toFixed(2) }}</h3>
          <p>Total Vendido</p>
        </div>
      </div>
      
      <div class="summary-card pagado">
        <div class="card-icon">
          <i class="fas fa-coins"></i>
        </div>
        <div class="card-content">
          <h3>L {{ getTotalPagado().toFixed(2) }}</h3>
          <p>Total Pagado</p>
        </div>
      </div>
      
      <div class="summary-card ganancia" [class.positive]="getGananciaNeta() > 0" [class.negative]="getGananciaNeta() < 0">
        <div class="card-icon">
          <i class="fas fa-piggy-bank"></i>
        </div>
        <div class="card-content">
          <h3>L {{ getGananciaNeta().toFixed(2) }}</h3>
          <p>Ganancia Neta</p>
        </div>
      </div>
      
      <div class="summary-card ventas">
        <div class="card-icon">
          <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="card-content">
          <h3>{{ getTotalVentas() }}</h3>
          <p>Ventas Totales</p>
        </div>
      </div>
    </div>

    <!-- Sección de Sorteos con estilo minimalista -->
    <div class="sorteos-section">
      <div class="section-header">
        <h3><i class="fas fa-dice"></i> Gestión de Sorteos</h3>
      </div>
      
      <div class="sorteos-grid">
        <div *ngFor="let sorteo of sorteos" class="sorteo-card">
          <div class="sorteo-header">
            <h4>{{ sorteo.label }}</h4>
            <div class="sorteo-status">
              <span class="status-badge" [class.open]="isSorteoOpen(sorteo)" [class.closed]="!isSorteoOpen(sorteo)">
                {{ isSorteoOpen(sorteo) ? 'Abierto' : 'Cerrado' }}
              </span>
              <span class="close-time">{{ sorteo.closeTime }}</span>
            </div>
          </div>
          
          <div class="sorteo-content">
            <div *ngIf="getSorteoData(sorteo)?.numeroGanador; else setWinner">
              <!-- Resultados del sorteo -->
              <div class="winner-section">
                <div class="winner-number">
                  <i class="fas fa-trophy"></i>
                  <span>{{ getSorteoData(sorteo)?.numeroGanador }}</span>
                </div>
                <div class="factor">Factor: {{ getSorteoData(sorteo)?.factorMultiplicador || 70 }}</div>
              </div>
              
              <div class="sorteo-stats">
                <div class="stat-item vendido">
                  <span class="label">Vendido</span>
                  <span class="value">L {{ getSorteoData(sorteo)?.totalVendido?.toFixed(2) || '0.00' }}</span>
                </div>
                <div class="stat-item pagado">
                  <span class="label">Pagado</span>
                  <span class="value">L {{ getSorteoData(sorteo)?.totalPagado?.toFixed(2) || '0.00' }}</span>
                </div>
                <div class="stat-item ganancia" [class.positive]="(getSorteoData(sorteo)?.gananciaNeta || 0) > 0" 
                     [class.negative]="(getSorteoData(sorteo)?.gananciaNeta || 0) < 0">
                  <span class="label">Ganancia</span>
                  <span class="value">L {{ getSorteoData(sorteo)?.gananciaNeta?.toFixed(2) || '0.00' }}</span>
                </div>
              </div>
            </div>
            
            <ng-template #setWinner>
              <!-- Formulario para establecer ganador -->
              <div *ngIf="!isSorteoOpen(sorteo)" class="winner-form">
                <div class="form-group">
                  <label>Número Ganador:</label>
                  <input type="number" class="form-input" min="1" max="99" 
                         [(ngModel)]="winningNumbers[sorteo.name]" [disabled]="isLoading">
                </div>
                <div class="form-group">
                  <label>Factor Multiplicador:</label>
                  <input type="number" class="form-input" min="1" max="100" step="0.1" 
                         [(ngModel)]="factorMultiplicador[sorteo.name]" 
                         [value]="factorMultiplicador[sorteo.name] || 70" [disabled]="isLoading">
                </div>
                <button class="btn-set-winner" (click)="setWinningNumber(sorteo)" 
                        [disabled]="!winningNumbers[sorteo.name] || isLoading">
                  <i class="fas fa-trophy"></i> Establecer Ganador
                </button>
              </div>
              
              <div *ngIf="isSorteoOpen(sorteo)" class="sorteo-open-message">
                <i class="fas fa-clock"></i>
                <span>Sorteo abierto - Esperando cierre</span>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección de Ventas -->
    <div class="ventas-section">
      <div class="section-header">
        <h3><i class="fas fa-list"></i> Historial de Ventas</h3>
        <div class="section-actions">
          <button class="btn-action" (click)="exportarVentasExcel()" [disabled]="isLoading" title="Exportar a Excel">
            <i class="fas fa-file-excel"></i> Excel
          </button>
          <button class="btn-action" (click)="exportarVentasPDF()" [disabled]="isLoading" title="Exportar a PDF">
            <i class="fas fa-file-pdf"></i> PDF
          </button>
        </div>
      </div>
      
      <div class="ventas-table-container" *ngIf="sales.length > 0; else noSales">
        <div class="ventas-table">
          <div class="table-header">
            <div class="col-fecha">Fecha</div>
            <div class="col-sucursal">Sucursal</div>
            <div class="col-sorteo">Sorteo</div>
            <div class="col-total">Total</div>
            <div class="col-recibo">Recibo</div>
            <div class="col-acciones">Acciones</div>
          </div>
          
          <div class="table-body">
            <div *ngFor="let sale of sales; trackBy: trackBySale" class="table-row">
              <div class="col-fecha">{{ formatDateTime(sale.createdAt) }}</div>
              <div class="col-sucursal">{{ sale.sucursal }}</div>
              <div class="col-sorteo">{{ sale.sorteo }}</div>
              <div class="col-total">L {{ sale.total.toFixed(2) }}</div>
              <div class="col-recibo">{{ sale.numeroRecibo || sale.id.slice(-6) }}</div>
              <div class="col-acciones">
                <button class="btn-table-action" (click)="verDetalles(sale)" title="Ver detalles">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-table-action" (click)="reprintReceipt(sale)" title="Reimprimir">
                  <i class="fas fa-print"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <ng-template #noSales>
        <div class="no-data-message">
          <i class="fas fa-inbox"></i>
          <h4>No hay ventas para mostrar</h4>
          <p>Ajusta los filtros para ver diferentes resultados</p>
        </div>
      </ng-template>
    </div>

  </div>
</div>

<!-- Modal para crear/editar usuario -->
<div class="modal fade" [class.show]="showUserModal" [style.display]="showUserModal ? 'block' : 'none'" 
     tabindex="-1" role="dialog" (click)="showUserModal && $event.target === $event.currentTarget && closeUserModal()">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user"></i> {{ editingUser ? 'Editar Usuario' : 'Crear Usuario' }}
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeUserModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form #userForm="ngForm">
          <div class="form-group">
            <label for="userEmail">Email:</label>
            <input type="email" id="userEmail" class="form-input" required
                   [(ngModel)]="userFormData.email" name="email" 
                   placeholder="usuario@ejemplo.com">
          </div>

          <div class="form-group">
            <label for="userName">Nombre:</label>
            <input type="text" id="userName" class="form-input"
                   [(ngModel)]="userFormData.nombre" name="nombre" 
                   placeholder="Nombre completo del usuario">
          </div>
          
          <div class="form-group" *ngIf="!editingUser">
            <label for="userPassword">Contraseña:</label>
            <input type="password" id="userPassword" class="form-input" required
                   [(ngModel)]="userFormData.password" name="password" 
                   placeholder="Contraseña segura">
          </div>
          
          <div class="form-group">
            <label for="userRole">Rol:</label>
            <select id="userRole" class="form-input" 
                    [(ngModel)]="userFormData.role" name="role" required>
              <option value="admin">Administrador</option>
              <option value="sucursal">Sucursal</option>
            </select>
          </div>
          
          <div class="form-group" *ngIf="userFormData.role === 'sucursal'">
            <label for="userSucursal">Sucursal:</label>
            <input type="text" id="userSucursal" class="form-input" 
                   [(ngModel)]="userFormData.sucursal" name="sucursal" 
                   placeholder="Nombre de la sucursal">
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="userFormData.active" name="active">
              <span class="checkmark"></span>
              Usuario Activo
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-secondary" (click)="closeUserModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn-modal btn-primary" (click)="saveUser()" 
                [disabled]="!userForm.valid || isLoading">
          <i class="fas fa-save"></i> {{ editingUser ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>
</div>
 

<!-- Modal para cambiar contraseña de usuario -->
<div class="modal fade" [class.show]="showPasswordModal" [style.display]="showPasswordModal ? 'block' : 'none'" 
     tabindex="-1" role="dialog" (click)="showPasswordModal && $event.target === $event.currentTarget && closePasswordModal()">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-key"></i> Cambiar Contraseña
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closePasswordModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form #passwordForm="ngForm">
          <div class="form-group">
            <label for="newPassword">Nueva Contraseña:</label>
            <input type="password" id="newPassword" class="form-input" required
                   [(ngModel)]="newPassword" name="newPassword" 
                   placeholder="Ingrese la nueva contraseña">
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirmar Contraseña:</label>
            <input type="password" id="confirmPassword" class="form-input" required
                   [(ngModel)]="confirmPassword" name="confirmPassword" 
                   placeholder="Confirme la nueva contraseña">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-secondary" (click)="closePasswordModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn-modal btn-primary" (click)="changeUserPassword()" 
                [disabled]="!passwordForm.valid || newPassword !== confirmPassword || isLoading">
          <i class="fas fa-save"></i> Cambiar Contraseña
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE DETALLES DE VENTA -->
<div class="modal-overlay" *ngIf="showSaleDetailModal" (click)="closeSaleDetailModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-receipt"></i> Detalles de Venta</h3>
      <button type="button" class="btn-close" (click)="closeSaleDetailModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedSaleForDetail">
      <!-- Información General -->
      <div class="sale-info-grid">
        <div class="info-row">
          <span class="label">Recibo:</span>
          <span class="value">{{ selectedSaleForDetail.numeroRecibo }}</span>
        </div>
        <div class="info-row">
          <span class="label">Correlativo:</span>
          <span class="value">{{ selectedSaleForDetail.correlativo }}</span>
        </div>
        <div class="info-row">
          <span class="label">Fecha:</span>
          <span class="value">{{ formatDateTime(selectedSaleForDetail.createdAt) }}</span>
        </div>
        <div class="info-row">
          <span class="label">Sucursal:</span>
          <span class="value">{{ selectedSaleForDetail.sucursal }}</span>
        </div>
        <div class="info-row">
          <span class="label">Sorteo:</span>
          <span class="value text-capitalize">{{ selectedSaleForDetail.sorteo }}</span>
        </div>
        <div class="info-row total-row">
          <span class="label">Total:</span>
          <span class="value">L {{ selectedSaleForDetail.total.toFixed(2) }}</span>
        </div>
      </div>

      <!-- Números Jugados -->
      <div class="numbers-section" *ngIf="selectedSaleDetails.length > 0">
        <h4><i class="fas fa-list"></i> Números Jugados</h4>
        <div class="numbers-grid">
          <div class="number-item" *ngFor="let detail of selectedSaleDetails; trackBy: trackBySaleDetail">
            <div class="number-card">
              <div class="number">{{ detail.numero.toString().padStart(2, '0') }}</div>
              <div class="amount">L {{ detail.monto.toFixed(2) }}</div>
            </div>
          </div>
        </div>
        
        <div class="numbers-summary">
          <div class="summary-item">
            <span class="label">Cantidad de números:</span>
            <span class="value">{{ selectedSaleDetails.length }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Total apostado:</span>
            <span class="value">L {{ getTotalNumeros().toFixed(2) }}</span>
          </div>
        </div>
      </div>
      
      <div class="no-numbers" *ngIf="selectedSaleDetails.length === 0">
        <i class="fas fa-exclamation-triangle"></i>
        <p>No se encontraron números para esta venta</p>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn-modal btn-primary" (click)="reprintReceipt(selectedSaleForDetail!)" 
              [disabled]="isLoading">
        <i class="fas fa-print"></i> Reimprimir Recibo
      </button>
      <button type="button" class="btn-modal btn-secondary" (click)="closeSaleDetailModal()">
        <i class="fas fa-times"></i> Cerrar
      </button>
    </div>
  </div>
</div>
