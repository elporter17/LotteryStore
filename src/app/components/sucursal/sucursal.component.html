<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Sucursal: {{ currentUser?.sucursal }}</h2>
    <button class="btn btn-danger" (click)="logout()" [disabled]="isLoading">
      <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
    </button>
  </div>

  <div class="card">
    <h3><i class="fas fa-clock"></i> Sorteo Actual</h3>
    <div *ngIf="currentSorteo; else noSorteo">
      <div class="alert alert-info">
        <strong>{{ currentSorteo.label }}</strong> - 
        <span *ngIf="isSorteoOpen" class="text-success">
          <i class="fas fa-check-circle"></i> Abierto (cierra {{ timeUntilClose }})
        </span>
        <span *ngIf="!isSorteoOpen" class="text-danger">
          <i class="fas fa-times-circle"></i> Cerrado
        </span>
      </div>
      
      <div *ngIf="isSorteoOpen && !isBlocked" class="row">
        <!-- Botón para abrir modal de selección -->
        <div class="col-12 text-center mb-4">
          <button class="btn btn-primary btn-lg" (click)="openNumberModal()" [disabled]="isLoading">
            <i class="fas fa-plus-circle"></i> Agregar Número
          </button>
        </div>
      </div>
      
      <!-- Mensaje de bloqueo -->
      <div *ngIf="isBlocked" class="alert alert-danger">
        <i class="fas fa-lock"></i> 
        <strong>Venta bloqueada:</strong> Faltan menos de 5 minutos para el cierre del sorteo.
      </div>
      
      <div *ngIf="selectedNumbers.length > 0" class="mt-4">
        <div class="card">
          <div class="card-header">
            <h4><i class="fas fa-shopping-cart"></i> Venta Actual</h4>
          </div>
          <div class="card-body">
            <div class="selected-numbers-container">
              <div *ngFor="let item of selectedNumbers; let i = index" 
                   class="selected-number-item">
                <div class="number-info">
                  <span class="number-badge">{{ item.numero.toString().padStart(2, '0') }}</span>
                  <span class="amount-text">L. {{ item.monto.toFixed(2) }}</span>
                </div>
                <button class="btn btn-danger btn-sm delete-btn" 
                        (click)="confirmRemoveNumber(i)" [disabled]="isLoading">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <div class="total-section mt-3">
              <div class="total-display">
                <strong><i class="fas fa-calculator"></i> Total: L. {{ getTotal().toFixed(2) }}</strong>
              </div>
              <button class="btn btn-success btn-lg" (click)="processSale()" 
                      [disabled]="selectedNumbers.length === 0 || isLoading || isBlocked">
                <i class="fas fa-cash-register"></i> Procesar Venta
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Historial de Ventas del Día Actual -->
      <div *ngIf="recentSales.length > 0" class="mt-4">
        <div class="card">
          <div class="card-header">
            <h4><i class="fas fa-history"></i> Ventas del Día ({{ getTodayDate() }})</h4>
          </div>
          <div class="card-body">
            <div class="sales-history-container">
              <div *ngFor="let sale of getFilteredSales()" class="sale-item">
                <div class="sale-info">
                  <div class="sale-header">
                    <span class="sale-time">
                      <i class="fas fa-clock"></i> {{ formatTime(sale.createdAt) }}
                    </span>
                    <span class="sale-total">
                      <i class="fas fa-dollar-sign"></i> L. {{ sale.total.toFixed(2) }}
                    </span>
                  </div>
                  <div class="sale-numbers">
                    <span *ngFor="let detail of getSaleDetails(sale.id)" class="number-badge-small">
                      {{ detail.numero.toString().padStart(2, '0') }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <ng-template #noSorteo>
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> No hay sorteo activo en este momento.
      </div>
    </ng-template>
  </div>

  <div class="card mt-4">
    <h3><i class="fas fa-chart-line"></i> Ventas del Día</h3>
    
    <div class="row mb-3">
      <div class="col-md-4">
        <label><i class="fas fa-calendar"></i> Filtrar por fecha:</label>
        <input type="date" class="form-control" [(ngModel)]="filterDate" 
               (change)="onFilterDateChange()" [disabled]="isLoading">
      </div>
    </div>
    
    <div *ngIf="isLoading" class="text-center">
      <div class="spinner-border" role="status">
        <span class="sr-only">Cargando...</span>
      </div>
    </div>
    
    <div *ngIf="!isLoading && filteredSales.length > 0; else noSales">
      <div *ngFor="let sale of filteredSales" class="card mb-2">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title">
                <i class="fas fa-ticket-alt"></i> {{ sale.sorteo | uppercase }}
              </h5>
              <p class="card-text">
                <i class="fas fa-clock"></i> {{ sale.fecha | date:'medium' }}
              </p>
            </div>
            <div class="text-right">
              <h4 class="text-success">L. {{ sale.total.toFixed(2) }}</h4>
              <button class="btn btn-sm btn-outline-primary" 
                      (click)="reprintReceipt(sale)">
                <i class="fas fa-print"></i> Reimprimir
              </button>
            </div>
          </div>
          <div class="mt-2">
            <h6><i class="fas fa-list-ol"></i> Números jugados:</h6>
            <div class="row">
              <div *ngFor="let detail of getSaleDetails(sale.id)" class="col-md-6 mb-1">
                <span class="badge badge-info">
                  Nº {{ detail.numero.toString().padStart(2, '0') }}: L. {{ detail.monto.toFixed(2) }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <ng-template #noSales>
      <div class="alert alert-info" *ngIf="!isLoading">
        <i class="fas fa-info-circle"></i> No hay ventas registradas para la fecha seleccionada.
      </div>
    </ng-template>
  </div>
</div>

<!-- Modal 1: Selección de Número -->
<div class="modal" [style.display]="showNumberModal ? 'flex' : 'none'" 
     [class.show]="showNumberModal" (click)="closeAllModals()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-hashtag"></i> Seleccionar Número
        </h5>
        <button type="button" class="close" (click)="closeAllModals()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="calculator-container">
          <!-- Display del número -->
          <div class="calculator-display">
            <span class="display-label">NUMERO</span>
            <div class="display-value">{{ (modalNumberInput || '00').padStart(2, '0') }}</div>
          </div>
          
          <!-- Teclado numérico -->
          <div class="calculator-keypad">
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalNumber(1); $event.stopPropagation()">1</button>
              <button type="button" class="keypad-btn" (click)="pressModalNumber(2); $event.stopPropagation()">2</button>
              <button type="button" class="keypad-btn" (click)="pressModalNumber(3); $event.stopPropagation()">3</button>
            </div>
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalNumber(4); $event.stopPropagation()">4</button>
              <button type="button" class="keypad-btn" (click)="pressModalNumber(5); $event.stopPropagation()">5</button>
              <button type="button" class="keypad-btn" (click)="pressModalNumber(6); $event.stopPropagation()">6</button>
            </div>
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalNumber(7); $event.stopPropagation()">7</button>
              <button type="button" class="keypad-btn" (click)="pressModalNumber(8); $event.stopPropagation()">8</button>
              <button type="button" class="keypad-btn" (click)="pressModalNumber(9); $event.stopPropagation()">9</button>
            </div>
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalNumber(0); $event.stopPropagation()">0</button>
              <button type="button" class="keypad-btn keypad-clear" (click)="clearModalNumber(); $event.stopPropagation()">
                C
              </button>
              <button type="button" class="keypad-btn keypad-accept" (click)="acceptModalNumber(); $event.stopPropagation()" 
                      [disabled]="!modalNumberInput">
                Aceptar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal 2: Selección de Apuesta -->
<div class="modal" [style.display]="showAmountModal ? 'flex' : 'none'" 
     [class.show]="showAmountModal" (click)="closeAllModals()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-dollar-sign"></i> Ingresar Apuesta
        </h5>
        <button type="button" class="close" (click)="closeAllModals()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="calculator-container">
          <!-- Display de la apuesta -->
          <div class="calculator-display">
            <span class="display-label">APUESTA</span>
            <div class="display-value">{{ modalAmountInput || '00' }}</div>
          </div>
          
          <!-- Teclado numérico -->
          <div class="calculator-keypad">
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalAmount(1); $event.stopPropagation()">1</button>
              <button type="button" class="keypad-btn" (click)="pressModalAmount(2); $event.stopPropagation()">2</button>
              <button type="button" class="keypad-btn" (click)="pressModalAmount(3); $event.stopPropagation()">3</button>
            </div>
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalAmount(4); $event.stopPropagation()">4</button>
              <button type="button" class="keypad-btn" (click)="pressModalAmount(5); $event.stopPropagation()">5</button>
              <button type="button" class="keypad-btn" (click)="pressModalAmount(6); $event.stopPropagation()">6</button>
            </div>
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalAmount(7); $event.stopPropagation()">7</button>
              <button type="button" class="keypad-btn" (click)="pressModalAmount(8); $event.stopPropagation()">8</button>
              <button type="button" class="keypad-btn" (click)="pressModalAmount(9); $event.stopPropagation()">9</button>
            </div>
            <div class="keypad-row">
              <button type="button" class="keypad-btn" (click)="pressModalAmount(0); $event.stopPropagation()">0</button>
              <button type="button" class="keypad-btn keypad-clear" (click)="clearModalAmount(); $event.stopPropagation()">
                C
              </button>
              <button type="button" class="keypad-btn keypad-accept" (click)="acceptModalAmount(); $event.stopPropagation()" 
                      [disabled]="!modalAmountInput">
                Aceptar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal 3: Confirmación -->
<div class="modal" [style.display]="showConfirmModal ? 'flex' : 'none'" 
     [class.show]="showConfirmModal" (click)="closeAllModals()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-check-circle"></i> Confirmar Apuesta
        </h5>
        <button type="button" class="close" (click)="closeAllModals()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="confirmation-container">
          <div class="confirmation-card">
            <div class="number-display-large">
              # {{ tempNumber !== null ? tempNumber.toString().padStart(2, '0') : '00' }}
            </div>
            <div class="amount-display">
              APUESTA: L {{ tempAmount || 0 }}
            </div>
            <div class="confirmation-buttons">
              <button type="button" class="btn btn-success btn-lg" (click)="confirmAddNumber()">
                <i class="fas fa-check"></i> CONFIRMAR
              </button>
              <button type="button" class="btn btn-secondary btn-lg" (click)="cancelAddNumber()">
                <i class="fas fa-times"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Eliminar el backdrop separado ya que usamos el modal completo -->
